# 实验1CMOS反相器（非门）
> “反者道之动；弱者道之用。”
>
> ——《道德经》，老子

反相器，或者说非门，是数字设计的核心。反相器设计是一个最基本的入门实验，类似于C语言编程中的“Hello World实验”，通过反相器的设计，我们可以一窥数字集成电路设计的流程与特点。
## 1.1.CMOS反相器电路设计
CMOS反相器由两个互补工作的MOS管组成，下图展示了CMOS反相器的电路图，其中的VDD表示电源电压，输入信号为a，输出信号为y。
???+ info "反相器原理图"
    ![](./图片/图片1.png)

时域仿真的结果如下图所示：
???+ info "CMOS反相器输出结果"
    ![](./图片/图片2.png)

其实我们可以使用MOS管的开关模型来直观的审视反相器电路的原理，如下图所示。可以看到，当输入信号为VDD时：NMOS导通，PMOS关断。因此可以看作是PMOS的开关断开，NMOS变成一个电阻（为何NMOS变成一个电阻？而不是一个导线呢？思考一下，稍后会解答）。此时，输出通过“化身为”电阻的NMOS连接到GND，所以输出电压为GND。
同理，当输入信号为0V时：NMOS关断，PMOS导通。因此可以看作是NMOS的开关断开，PMOS变成一个电阻。此时，输出通过“化身为”电阻的PMOS连接到VDD，所以输出电压为VDD。可以看到，通过互补的NMOS和PMOS，我们实现了对输入信号的反相，也就是说我们实现了一个数字电路中的非门！恭喜，我们成功解锁了数字电路的第一个门——非门。
???+ info "CMOS反相器的开关模型"
    ![](./图片/图片3.png)

## 1.2.晶体管等效导通电阻
问题引入：为何NMOS或者PMOS导通时视作电阻而不是导线呢？
我们不妨回想一下，我们可以将一个器件视作导线的基本假设是什么？是这个器件的电阻阻值非常小。你可能会问：“MOS管在导通时候的阻值不就应该很小吗？”可惜，事实并非如此，MOS管的导通等效电阻与供电电压、工艺参数等有关，具体可以通过下式进行计算（公式很长，不要害怕，了解即可）：

$$
R_{eq} = \frac{1}{2} (\frac{VDD}{I_{DSAT}(1 + \lambda \cdot VDD)}) + \frac{VDD/2}{I_{DSAT}(1 + \lambda \cdot VDD/2)}) \approx \frac{3}{4} \frac{VDD}{I_{DSAT}} (1 - \frac{5}{6} \lambda  \cdot VDD)
$$

其中，$I_{DSAT}$代表饱和电流，VDD表示工作电压，表示沟道调制系数。
一个0.25um CMOS工艺的NMOS和PMOS晶体管在导通时的电阻取值如下表所示：
**表 1 0.25um CMOS工艺（沟道长度为最小）的NMOS和PMOS晶体管（W/L = 1）的等效电阻Req**

| VDD（V） | 1 | 1.5	| 2	|2.5 |
|:---------:|:---:|:--:|:--:|:--:|
| NMOS（kΩ）| 35  | 19 | 15 | 13 |
| PMOS（kΩ）| 115 | 55 | 38 | 31 |

先不着急，我知道，现在的你很惊讶：晶体管在导通时候的阻值居然这么大？！
我们不妨来验证一下。我们让输入信号为低电平，输出信号为高电平。然后我们在输出端口连接一个阻值为100k的大电阻（此时电路相当于一个电阻分压模型）：如果晶体管导通时的电阻阻值和100k接近，那么输出的电压就会被晶体管等效导通电阻和输出电阻分压；如果晶体管导通时的电阻很小，那么相当于输出电压都被100k电阻“分走了”，那么输出电压变化应该不大。
结果不出所料，输出的高电压变为了2.8V（原始输出电压为3.3V），这说明有一部分电压被晶体管等效导通电阻“分走了”。
???+ info "测试导通等效电阻电路图"
    ![](./图片/图片4.png)
???+ info "输出高电平结果"
    ![](./图片/图片5.png)

## 1.3.故事时间：CMOS工艺
在微电子专业的保研面试中，经常出现的一道题就是：请你说一下CMOS工艺的英文以及中文含义。
CMOS工艺英文全称是Complementary Metal Oxide Semiconductor ，中文翻译为互补金属氧化物半导体。其中互补的含义就表示由NMOS和PMOS两个互补的器件来共同构成电路，例如在反相器中，我们就巧妙地利用了NMOS和PMOS互补的特性。
虽然这个互补的想法很符合我们的直觉，但是实际上，在20世纪70年代以及20世纪80年代早期，所有的早期处理器（例如大名鼎鼎的Intel4004）都是只用NMOS工艺实现的，因为当时的工艺缺少互补器件，这导致反相器会产生静态功耗（会带来功耗增加、发热等负面影响）。直到20世纪80年代后期，当工艺技术缩小到允许更高集成密度时，工业界不得不转向CMOS。
## 1.4.使用自己定义的MOSFET模型
虽然我们成功的实现了反相器的功能，但是我们不禁想问几个问题：1）这个仿真准确吗？2）我们使用的晶体管的工艺是多少节点呢？3）这个晶体管模型是不是过于理想？
关于LTspice中的MOSFET模型，请大家自行RTFM，点击LTspice的help，大家可以找到MOSFET的相关描述。在这里，我们着重关注以下几个指标：晶体管沟道长度（L），沟道宽度（W），寄生电容。通过阅读手册我们得知：在默认情况下1）晶体管沟道长度L和宽度W均为100um，2）晶体管的许多寄生电容均为0。
???+ info "晶体管默认沟道长度和宽度"
    ![](./图片/图片6.png)
???+ info "晶体管默认电容"
    ![](./图片/图片7.png)

这对于我们来说是十分不友好的。首先，因为目前绝大部分的工艺已经是深亚微米（沟道长度小于1um），先进工艺的等效沟道长度（**并非实际沟道长度**）已经达到5nm，3nm甚至1nm以下（例如GAA工艺），100um的工艺对于我们来说有些过于“落后”了。其次，我们在接下来的“旅途”中，会遇到很多电路正是利用了晶体管的某些寄生电容才可以实现正常的功能（例如动态逻辑就是利用了晶体管的寄生电容），所以默认的模型不仅结果过于理想，不准确，甚至会使得我们许多电路的功能无法正常仿真。
因此，我们这里使用教材提供的0.25um CMOS工艺模型，大家可以通过访问教材的配套网址（http://icbook.eecs.berkeley.edu）进行下载，同时我也在工程文件夹\mylib中存放了，文件为：cmos25_level49.lib。
这里我们对原始代码进行了3个改变：
+ 我们将NMOS和PMOS的模型分别命名为mynmos和mypmos，以和原始模型进行区别
+ 我们将最大晶体管长度LMAX参数设置为'10E-06-dxl'，原始LMAX仅为0.5um对于我们来说过小
+ 为了防止当NMOS的L较大时参数Delta小于0报错，我们将DELTA参数设置为0.05，虽然会一定程度影响准确性，但是可以满足我们的要求。
通过在原理图界面添加如下SPICE命令引用我们的模型（*表示注释）：
```
* 引入教材给出的0.25um的MOSFET模型
* 注意：请务必给出MOS的长和宽，否则默认值为100um
* 因为我们在LTspice的设置中添加了地址，所以这里可以直接找到
.lib 'cmos25_level49.lib' TT
```
## 1.5.构建自己的电路模块库
在我们构建大规模集成电路的时候，很多模块都会复用，这一点对于使用HDL语言的同学一定不会陌生（例如Verilog就是由一个一个module构成）。因此，我们一般会把反相器这样的基本单元进行封装，从而构建自己的电路模块库。
请你通过STFW的方式将反相器封装为一个电路模型，注意，使用我们自己定义的mynmos和mypmos模型！并在其他文件中试着调用。
## 1.6.动手实验内容
1. 请仿真反相器的电压传输特性曲线（VTC），即展示Vout和Vin之间的关系。
提示：使用LTspice的dc扫描功能。
2. 并想想曲线不同部分NMOS和PMOS分别处于什么工作区。（需要半导体物理与器件等相关知识）
3. 试着改变我们定义的MOSFET中的各个参数，观察变化后的实验结果。并从半导体物理的角度解释为什么。